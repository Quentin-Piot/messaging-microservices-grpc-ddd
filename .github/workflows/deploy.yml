# .github/workflows/deploy.yml
name: Deploy to AWS

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-3


      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Debug Directory
        run: |
          pwd
          ls -la
          ls -la terraform/

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply -auto-approve -var="ssh_key_name=${{ secrets.EC2_SSH_KEY_DEV_NAME }}"

      - name: Get EC2 IP
        run: echo "EC2_IP=$(terraform output -raw public_ip)" >> $GITHUB_ENV

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY_DEV }}" > ~/.ssh/private.key
          chmod 600 ~/.ssh/private.key
          ssh-keyscan -H ${{ env.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Deploy Application
        run: |
          scp -i ~/.ssh/private.key -r ./ ubuntu@${{ env.EC2_IP }}:~/app
          ssh -i ~/.ssh/private.key ubuntu@${{ env.EC2_IP }} '
            cd ~/app
            sudo docker-compose -f apps/backend/api-gateway/ci/docker-compose.yml up -d
            sudo docker-compose -f apps/backend/user-service/ci/docker-compose.yml up -d
          '